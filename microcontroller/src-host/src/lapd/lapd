#!/usr/bin/ruby

require 'socket'

class Can_packet
	attr_reader :src_addr
	attr_reader :dest_addr
	attr_reader :src_port
	attr_reader :dest_port

	attr_reader :id
	attr_reader :data

	def initialize
		@src_addr = 0
		@dest_addr = 0
		@src_port = 0
		@dest_port = 0

		@id = 0x1fffffff
		@data = Array.new
		@dlc = 0
	end

	def id_to_lap
		@src_addr = (@id>>8) & 0xff
		@dest_addr = @id & 0xff
		@src_port = (@id>>23) & 0x3f
		@dest_port = ((@id>>17) & 0x30) | ((@id>>16) & 0x0f)
	end

	def read_from_socket(s)
		c = s.getc
		
		bytes = Array.new
		(c+1).times do
			bytes << s.getc
		end

		if bytes[0] == 0x11 then
			@id = bytes[1] | (bytes[2] << 8) | (bytes[3] << 16) | (bytes[4] << 24)
			@dlc = bytes[5]
			@data = bytes[6..(5+@dlc)]
			self.id_to_lap()
		end
	end
end


class LapDevice
	attr_reader :type
	attr_reader :name
	def initialize(type, name)
		@type = type
		@name = name
	end
end

class LampDevice << LapDevice
	def initialize(type, name)
	end
end

$servers = []

class LapServer
	def initialize(sock)
		@sock = sock
		Thread.new{
			while 1
				line = sock.gets
				args = /^(\w+)\s+(\w+)\s+(\w+)\s+(\w+)/.match(line)
				if args == nil then break end
				
				
			end
			sock.close
			$servers.delete(self)
		}
	end
end



server_thread = Thread.new{
	session = TCPServer.new( '' , 2343 )
	while 1
		$servers << LapServer.new(session.accept)
	end
}


while 1
	p $servers
	sleep 100000
end

server_thread.join

#sock = TCPSocket.new('rl', '2342')
can = Can_packet.new()
can.read_from_socket(sock)


p can

