/* keys.c */
/*
 *   This file is part of AnonAccess, an access system which can be used
 *    to open door or doing other things with an anonymity featured
 *    account managment.
 *   Copyright (C) 2006, 2007, 2008  Daniel Otte (daniel.otte@rub.de)
 *
 *   This program is free software: you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *   (at your option) any later version.
 *
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 *
 *   You should have received a copy of the GNU General Public License
 *   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */



#include "keys.h"
#include "24Cxxx.h"
#include "hmac-sha256.h"
#include <avr/eeprom.h>
#include <string.h>

/****************************************************
 ****************************************************/

uint8_t master_key[32] EEMEM = {0x7c, 0x40, 0xc8, 0x3c, 0x84, 0x11, 0x8a, 0xec,
                                0x66, 0x66, 0x5d, 0x9f, 0x3b, 0x79, 0x55, 0x63,
                                0x68, 0x3e, 0xc3, 0xb2, 0x20, 0xc6, 0xa7, 0x7e,
                                0x13, 0x54, 0x88, 0x77, 0x02, 0x9b, 0xb9, 0x8a};

uint8_t ticket_key[32] EEMEM = {0x8c, 0x40, 0xc8, 0x3c, 0x84, 0x11, 0x8a, 0xec,
                                0x66, 0x66, 0x5d, 0x9f, 0x3b, 0x79, 0x55, 0x63,
                                0x68, 0x3e, 0xc3, 0xb2, 0x20, 0xc6, 0xa7, 0x7e,
                                0x13, 0x54, 0x88, 0x77, 0x02, 0x9b, 0xb9, 0x8a};

uint8_t ticketkeydiv1[32] EEMEM = {0x8c, 0x40, 0xc8, 0x3c, 0x84, 0x11, 0x8a, 0xec,
                                0x66, 0x66, 0x5d, 0x9f, 0x3b, 0x79, 0x55, 0x63,
                                0x68, 0x3e, 0xc3, 0xb2, 0x20, 0xc6, 0xa7, 0x7e,
                                0x14, 0x54, 0x88, 0x77, 0x02, 0x9b, 0xb9, 0x8a};

uint8_t ticketkeydiv2[32] EEMEM = {0x8c, 0x40, 0xc8, 0x3c, 0x84, 0x11, 0x8a, 0xec,
                                0x66, 0x66, 0x5d, 0x9f, 0x3b, 0x79, 0x55, 0x63,
                                0x68, 0x3e, 0xc3, 0xb2, 0x20, 0xc6, 0xa7, 0x7e,
                                0x15, 0x54, 0x88, 0x77, 0x02, 0x9b, 0xb9, 0x8a};


uint8_t absign_key[32] EEMEM = {0x9c, 0x40, 0xc8, 0x3c, 0x84, 0x11, 0x8a, 0xec,
                                0x66, 0x66, 0x5d, 0x9f, 0x3b, 0x79, 0x55, 0x63,
                                0x68, 0x3e, 0xc3, 0xb2, 0x20, 0xc6, 0xa7, 0x7e,
                                0x13, 0x54, 0x88, 0x77, 0x02, 0x9b, 0xb9, 0x8a};

uint8_t rid_key[32] EEMEM    = {0xac, 0x40, 0xc8, 0x3c, 0x84, 0x11, 0x8a, 0xec,
                                0x66, 0x66, 0x5d, 0x9f, 0x3b, 0x79, 0x55, 0x63,
                                0x68, 0x3e, 0xc3, 0xb2, 0x20, 0xc6, 0xa7, 0x7e,
                                0x13, 0x54, 0x88, 0x77, 0x02, 0x9b, 0xb9, 0x8a};

uint8_t nick_key[32] EEMEM   = {0xbc, 0x40, 0xc8, 0x3c, 0x84, 0x11, 0x8a, 0xec,
                                0x66, 0x66, 0x5d, 0x9f, 0x3b, 0x79, 0x55, 0x63,
                                0x68, 0x3e, 0xc3, 0xb2, 0x20, 0xc6, 0xa7, 0x7e,
                                0x13, 0x54, 0x88, 0x77, 0x02, 0x9b, 0xb9, 0x8a};

uint8_t timestamp_key[32] EEMEM   = {0xcc, 0x40, 0xc8, 0x3c, 0x84, 0x11, 0x8a, 0xec,
                                0x66, 0x66, 0x5d, 0x9f, 0x3b, 0x79, 0x55, 0x63,
                                0x68, 0x3e, 0xc3, 0xb2, 0x20, 0xc6, 0xa7, 0x7e,
                                0x13, 0x54, 0x88, 0x77, 0x02, 0x9b, 0xb9, 0x8a};
 
uint8_t pinmac_key[32] EEMEM   = {0xdc, 0x40, 0xc8, 0x3c, 0x84, 0x11, 0x8a, 0xec,
                                0x66, 0x66, 0x5d, 0x9f, 0x3b, 0x79, 0x55, 0x63,
                                0x68, 0x3e, 0xc3, 0xb2, 0x20, 0xc6, 0xa7, 0x7e,
                                0x13, 0x54, 0x88, 0x77, 0x02, 0x9b, 0xb9, 0x8a}; 
 
uint8_t pinenc_key[32] EEMEM   = {0xfc, 0x40, 0xc8, 0x3c, 0x84, 0x11, 0x8a, 0xec,
                                0x66, 0x66, 0x5d, 0x9f, 0x3b, 0x79, 0x55, 0x63,
                                0x68, 0x3e, 0xc3, 0xb2, 0x20, 0xc6, 0xa7, 0x7e,
                                0x13, 0x54, 0x88, 0x77, 0x02, 0x9b, 0xb9, 0x8a}; 
  
uint8_t eeprom_crypt_key[32] EEMEM   = {0xec, 0x40, 0xc8, 0x3c, 0x84, 0x11, 0x8a, 0xec,
                                0x66, 0x66, 0x5d, 0x9f, 0x3b, 0x79, 0x55, 0x63,
                                0x68, 0x3e, 0xc3, 0xb2, 0x20, 0xc6, 0xa7, 0x7e,
                                0x13, 0x54, 0x88, 0x77, 0x02, 0x9b, 0xb9, 0x8a};
 
uint8_t eeprom_key[32]; 
 
 
void delete_key(void* key, uint16_t length){
	memset(key, 0x00, length);
	memset(key, 0xFF, length);
	memset(key, 0xAA, length);
	memset(key, 0x55, length);
	memset(key, 0xFF, length);
	memset(key, 0x00, length);
	memset(key, 0xFF, length);
} 
                   
void load_key(void* dest, void* key){
	uint8_t a[32],b[32];
	eeprom_read_block(a, key, 32);
	eeprom_read_block(b, master_key, 32);
	hmac_sha256(dest,b,256,a,256);
	delete_key(a,32);
	delete_key(b,32);
}                                

void load_ticketkey(void* dest){
	load_key(dest, ticket_key);
} 

void load_absignkey(void* dest){
	load_key(dest, absign_key);
}

void load_ridkey(void* dest){
	load_key(dest, rid_key);
}

void load_ticketkeydiv1(void* dest){
	load_key(dest, ticketkeydiv1);
}


void load_ticketkeydiv2(void* dest){
	load_key(dest, ticketkeydiv2);
}

void load_nickkey(void* dest){
	load_key(dest, nick_key);
}

void load_timestampkey(void* dest){
	load_key(dest, timestamp_key);
}

void load_pinmac_key(void* dest){
	load_key(dest, pinmac_key);
}

void load_pinenc_key(void* dest){
	load_key(dest, pinenc_key);
}

void load_eeprom_crypt_key(void* dest){
	load_key(dest, eeprom_crypt_key);
}

void do_keymigrate(void){
	uint8_t buffer[32];
	uint16_t addr=0;
	
	load_ticketkey(buffer);
	E24C_page_write(0xA0, addr,buffer,32);
	addr += 32;
	
	load_absignkey(buffer);
	E24C_page_write(0xA0, addr,buffer,32);
	addr += 32;
	
	load_ridkey(buffer);
	E24C_page_write(0xA0, addr,buffer,32);
	addr += 32;
	
	load_nickkey(buffer);
	E24C_page_write(0xA0, addr,buffer,32);
	addr += 32;
	
	load_timestampkey(buffer);
	E24C_page_write(0xA0, addr,buffer,32);
	addr += 32;
	
	load_eeprom_crypt_key(buffer);
	E24C_page_write(0xA0, addr,buffer,32);
	addr += 32;
	
}


