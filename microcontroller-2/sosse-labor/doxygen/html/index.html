<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SOSSE: SOSSE - Simple Operating System for Smartcard Education</title>
<link href="sos.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li id="current"><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<h1>SOSSE - Simple Operating System for Smartcard Education</h1>
<p>
<h1>Overview</h1>
<p>
SOSSE is a simple operating system for smart cards which is opensource and free. It has been developed to provide a smart card platform for learning, experimenting and implementing inovative concepts. The hardware platform choosen for this project are the Funcards based on commercial-of-the-shelf AVR microcontrollers, because the hardware documentation is available without non-disclosure agreement.<p>
<div align="center">
<img src="funcard2.jpg" alt="funcard2.jpg">
</div>
<p>
<h1>Hardware</h1>
<p>
All of the currently supported cards use the AVR-Microcontrollers from <a href="http://www.atmel.com/" 
	>>Atmel</a>. The are e.g. called Funcard, Jupiter or Pink card. The used AVRs are the AT90S2323, AT90S2343, AT90S8515 and AT90S8535. There are even a few boards with the ATmega161 available. The data sheets for all Atmel AVR microcontrollers are available on the Atmel website.<p>
<div align="center">
<img src="purple.gif" alt="purple.gif">
</div>
 <p>
The pinout of the AVR cards is as follows:<p>
<ul>
<li>
C1 (VCC): Vcc </li>
<li>
C2 (RST): RESET </li>
<li>
C3 (CLK): XTAL </li>
<li>
C4: MOSI </li>
<li>
C5 (VSS): Vss </li>
<li>
C6: Not connected </li>
<li>
C7 (I/O): MISO </li>
<li>
C8: SCK </li>
</ul>
<p>
Additional to the smart cards, a programmer is needed. These are available at the same shops as the AVR cards.<p>
<h1>Software</h1>
<p>
SOSSE has been developed using the GCC development tools. These are available at <a href="http://combio.de/avr/" 
	>>http://combio.de/avr/</a>. There are the sources, binaries and RPMs for Linux and binaries for MS Windows.<p>
<h1>Design Decisions</h1>
<p>
<h2>Programming Language</h2>
<p>
The C programming language has been choosen instead of assembler, because:<p>
<ul>
<li>
It is easier to understand C source code. </li>
<li>
Modern smart card operating systems are probably all written mostly in C. Who does want to write and verify 128kB assembler code? </li>
<li>
When new smart card architectures are available for SOSSE, these can be utilized more easily. </li>
</ul>
<p>
<h1>Building Instructions</h1>
<p>
<h2>Standard Build</h2>
<p>
<ol>
<li>
Go to the src directory and edit <a class="el" href="config_8h.html">config.h</a>. This file contains the configuration data for the build process. The meaning of the options is described in the doxygen documention of <a class="el" href="config_8h.html">config.h</a> itself. (It is not possible to switch on all features, because then the code size is above 8kB.)<p>
</li>
<li>
You can edit eedata.S if you want to change the EEPROM data loaded onto the AVR card. You might want to change the card serial number, the start value for the random number generator, the keys, the file permissions or the created files.<p>
</li>
<li>
There are two defines in the Makefile, which could need editing. The first is the -mmcu setting in CC and the second is -mtiny-stack in CFLAGS. Adjust these to reflect your used AVR card.<p>
</li>
<li>
To build the HEX files start <em>make</em>.<p>
</li>
<li>
The resulting HEX files sosse.hex and eedata.hex (or BIN files sosse.bin and eedata.bin) have then to be loaded on the card with the programmer and an apropriate software. The destination for sosse.hex is the Flash and for eedata.hex the internal EEPROM.<p>
</li>
</ol>
<p>
<h2>Debugging</h2>
<p>
Test programms which run natively on the host operating system are built running:<p>
make -f Makefile.emu<p>
These can be used for comfortable debugging and testing using the normal GNU debugger. When the reset sequence is implemented, this can be used to simulate a SOSSE smart card via e.g. a Season interface.<p>
<h2>CT-API driver</h2>
<p>
<h3>Building</h3>
<p>
A virtual card sitting in a virtual reader can be build with:<p>
make -f Makefile.ctapi<p>
This builds a CT-API driver, which can be used to test applications and to debug using a normal debugger.<p>
<h3>Supported CT-BCS commands</h3>
<p>
<ul>
<li>
EJECT ICC: Supported with functional unit ICC1. P2 is ignored. </li>
<li>
GET STATUS: Supported tag is 80. Possible card states are 01 and 05. </li>
<li>
REQUEST ICC: Supported with functional unit ICC1 and response data none and complete ATR. Display settings are ignored. </li>
<li>
RESET CT: Supported with functional unit CT and ICC1 and response data none and complete ATR. This command is the same as REQUEST ICC, but does support reseting the CT, which stops the ICC. </li>
</ul>
<p>
<h3>Proprietary command: EEPROM FILE</h3>
<p>
<h3>Header</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>CLA </td><td>INS </td><td>P1 </td><td>P2 </td><td>P3  </td></tr>
<tr>
<td>20 </td><td>E0 </td><td>Flags </td><td>RFU </td><td>Length  </td></tr>
</table>
<p>
<h3>Command data</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>Byte(s) </td><td>Description </td><td>Length  </td></tr>
<tr>
<td>1 - Length </td><td>File name </td><td>Length  </td></tr>
</table>
<p>
<h3>Status words</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>SW </td><td>Description  </td></tr>
<tr>
<td>90 00 </td><td>Command completed successfully  </td></tr>
</table>
<p>
<h3>Description</h3>
<p>
This command sets the parameter for EEPROM loading and saving for the virtual card.<p>
If bit 1 of P1 is set, the EEPROM is saved at stopping of the ICC and if bit 2 is set, the EEPROM loaded at starting of the ICC. The file name for this operation is specified in the data field of the command.<p>
<em>The proprietary commands must be executed before a REQUEST ICC and RESET CT, because the parameters are held in RAM, which is separated by a fork at card reset.</em><p>
<em>A success of the command means only, that the variables have correctly been set. It does not verify, that the file is createable, readable or writeable.</em><p>
<h1>More Information and Download</h1>
<p>
The web page with up to date information about SOSSE is at:<br>
<a href="http://www.mbsks.franken.de/sosse/" 
	>>http://www.mbsks.franken.de/sosse/</a><p>
The download location of the SOSSE sources is at:<br>
<a href="ftp://ftp.franken.de/pub/crypt/chipcards/sosse/">ftp://ftp.franken.de/pub/crypt/chipcards/sosse/</a><p>
The documentation was generated using DoxyGen:<br>
<a href="http://www.doxygen.org/">http://www.doxygen.org/</a><p>
<h1>Special Files</h1>
<p>
These File are only used, when filesystem support is compiled in. Otherwise special absolut locations in EEPROM are used to hold the data.<p>
<h2>EF Ext Auth</h2>
<p>
Path: 3F00FF00<p>
Content:<p>
<ul>
<li>
16 Bytes Key </li>
<li>
1 Byte Retry Counter (resets to 10) </li>
</ul>
<p>
<h2>EF Int Auth</h2>
<p>
Path: 3F00FF01<p>
Content:<p>
<ul>
<li>
16 Bytes Key </li>
<li>
1 Byte Retry Counter (unused) </li>
</ul>
<p>
<h2>EF PIN</h2>
<p>
Path: 3F00FF02<p>
Content:<p>
<ul>
<li>
8 Bytes PIN </li>
<li>
1 Byte Retry Counter (resets to 3) </li>
<li>
8 Bytes PUK </li>
<li>
1 Byte Retry Counter (resets to 10) </li>
</ul>
<p>
<h1>Commands</h1>
<p>
<h2>Write EEPROM. (Test command)</h2>
<p>
<h3>Header</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>CLA </td><td>INS </td><td>P1 </td><td>P2 </td><td>P3  </td></tr>
<tr>
<td>80 </td><td>02 </td><td>Address high </td><td>Address low </td><td>Length  </td></tr>
</table>
<p>
<h3>Command data</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>Byte(s) </td><td>Description </td><td>Length  </td></tr>
<tr>
<td>1 - Length </td><td>Data to write to <em>Address</em> </td><td>Length  </td></tr>
</table>
<p>
<h3>Status words</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>SW </td><td>Description  </td></tr>
<tr>
<td>90 00 </td><td>Command completed successfully  </td></tr>
<tr>
<td>65 00 </td><td>Memory failure (unsuccessful writing)  </td></tr>
<tr>
<td>67 00 </td><td>Wrong Lc  </td></tr>
</table>
<p>
<h3>Description</h3>
<p>
This command can be used to directly write into EEPROM. The start address is specified in P1P2 and the data length in P3. If there exists an internal and external EEPROM, the address convention of the HAL is used. Currently the internal EEPROM is in the address range 0 - sizeof internal EEPROM. The external EEPROM starts directly afterwards.<p>
<em>This command should be disabled by setting CONF_WITH_TESTCMDS to 0 for a production version.</em><p>
<em>Data updates are NOT protected with transactions.</em><p>
<h2>Read EEPROM. (Test command)</h2>
<p>
<h3>Header</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>CLA </td><td>INS </td><td>P1 </td><td>P2 </td><td>P3  </td></tr>
<tr>
<td>80 </td><td>04 </td><td>Address high </td><td>Address low </td><td>Length  </td></tr>
</table>
<p>
<h3>Response data</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>Byte(s) </td><td>Description </td><td>Length  </td></tr>
<tr>
<td>1 - Length </td><td>Data read from <em>Address</em> </td><td>Length  </td></tr>
</table>
<p>
<h3>Status words</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>SW </td><td>Description  </td></tr>
<tr>
<td>90 00 </td><td>Command completed successfully  </td></tr>
</table>
<p>
<h3>Description</h3>
<p>
This command can be used to directly read from EEPROM. The start address is specified in P1P2 and the data length in P3. If there exists an internal and external EEPROM, the address convention of the HAL is used. Currently the internal EEPROM is in the address range 0 - sizeof internal EEPROM. The external EEPROM starts directly afterwards.<p>
<em>This command should be disabled by setting CONF_WITH_TESTCMDS to 0 for a production version.</em><p>
<h2>LED Effects (Fun command)</h2>
<p>
<h3>Header</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>CLA </td><td>INS </td><td>P1 </td><td>P2 </td><td>P3  </td></tr>
<tr>
<td>80 </td><td>06 </td><td>Effect </td><td>Parameter </td><td>00  </td></tr>
</table>
<p>
<h3>Status words</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>SW </td><td>Description  </td></tr>
<tr>
<td>90 00 </td><td>Command completed successfully  </td></tr>
</table>
<p>
<h3>Description</h3>
<p>
This command does control the LEDs present on some PCB AVR cards and shows some nice effects.<p>
Effect type 0x01 does switch the LEDs specified in P2 on. Each bit controlls one LED. Which LED is controlled may be card dependent. Currently bits 0 - 6 control the leds beginning from the left, when looking down at them with the contacts to the top.<p>
Effect type 0x02 does implement a runlight with the left 4 LED block. It may need adjustment on other cards to select the correct LEDs.<p>
<em>This command is only enabled when setting CONF_WITH_FUNNY to 1.</em><p>
<div align="center">
<img src="jupiter2.jpg" alt="jupiter2.jpg">
</div>
<p>
<h2>Change PIN.</h2>
<p>
<h3>Header</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>CLA </td><td>INS </td><td>P1 </td><td>P2 </td><td>P3  </td></tr>
<tr>
<td>80 </td><td>24 </td><td>00 </td><td>00 </td><td>10  </td></tr>
</table>
<p>
<h3>Command data</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>Byte(s) </td><td>Description </td><td>Length  </td></tr>
<tr>
<td>1 - 8 </td><td>Current PIN </td><td>8  </td></tr>
<tr>
<td>9 - 16 </td><td>New PIN </td><td>8  </td></tr>
</table>
<p>
<h3>Status words</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>SW </td><td>Description  </td></tr>
<tr>
<td>90 00 </td><td>Command completed successfully  </td></tr>
<tr>
<td>63 CX </td><td>Verification failed, retry counter specified  </td></tr>
<tr>
<td>67 00 </td><td>Wrong Lc  </td></tr>
<tr>
<td>69 83 </td><td>Authentication method blocked  </td></tr>
<tr>
<td>6A 86 </td><td>Incorrect parameters P1-P2  </td></tr>
<tr>
<td>6A 88 </td><td>Referenced data not found  </td></tr>
</table>
<p>
<h3>Description</h3>
<p>
This command changes the PIN of the card. The first four bytes of the data is the current PIN, which is checked for correctness. The second four bytes of the data is the new PIN, which will be written. On success the AUTH_FLAG_PIN bit in authstate is set, on fauilure it is cleared.<p>
<em>Warning: Currently the retry counter is not handled in a secure way. For more information see e.g. Rankl/Effing.</em><p>
<em>PIN update is protected with transactions.</em><p>
<h2>Create File.</h2>
<p>
<h3>Header</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>CLA </td><td>INS </td><td>P1 </td><td>P2 </td><td>P3  </td></tr>
<tr>
<td>80 </td><td>E0 </td><td>00 </td><td>00 </td><td>06  </td></tr>
</table>
<p>
<h3>Command data</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>Byte(s) </td><td>Description </td><td>Length  </td></tr>
<tr>
<td>1 - 2 </td><td>Size </td><td>2  </td></tr>
<tr>
<td>3 - 4 </td><td>FID </td><td>2  </td></tr>
<tr>
<td>5 </td><td>File type (DF: 38, EF: 00) </td><td>1  </td></tr>
<tr>
<td>6 </td><td>Access conditions (DF: Create/Delete, EF: Update/Read) </td><td>1  </td></tr>
</table>
<p>
<h3>Status words</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>SW </td><td>Description  </td></tr>
<tr>
<td>90 00 </td><td>Command completed successfully  </td></tr>
<tr>
<td>67 00 </td><td>Wrong Lc  </td></tr>
<tr>
<td>69 82 </td><td>Security status not satisfied  </td></tr>
<tr>
<td>69 86 </td><td>Command not allowed (no DF selected)  </td></tr>
<tr>
<td>6A 80 </td><td>Incorrect arameters in the data field  </td></tr>
<tr>
<td>6A 84 </td><td>Not enough free space in DF  </td></tr>
<tr>
<td>6A 86 </td><td>Incorrect parameters P1-P2  </td></tr>
<tr>
<td>6A 89 </td><td>File exists already  </td></tr>
</table>
<p>
<h3>Description</h3>
<p>
This command creates an elementary or dedicated file. To succeed the current file must be a dedicated file or the master file and the access conditions for file creation must be fulfilled.<p>
The data of the command is the file header. It consists of a 2-byte size, 2-byte FID, 1-byte type and 1-byte access conditions. Size can't be 0000. The FID can't be 3F00 or FFFF. Valid file types are 00 for EF and 38 for DF. The access conditions are described in the next tables.<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>File type </td><td>High Nibble </td><td>Low Nibble  </td></tr>
<tr>
<td>DF </td><td>Create File </td><td>Delete File  </td></tr>
<tr>
<td>EF </td><td>Update </td><td>Read  </td></tr>
</table>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>Nibble Value </td><td>Access condition  </td></tr>
<tr>
<td>0 </td><td>Always  </td></tr>
<tr>
<td>1 </td><td>PIN verified  </td></tr>
<tr>
<td>2 </td><td>External Authentication key verified  </td></tr>
<tr>
<td>3 </td><td>PIN or External Authentication Key verified  </td></tr>
<tr>
<td>4 </td><td>PIN and External Authentication Key verified  </td></tr>
<tr>
<td>F </td><td>Never  </td></tr>
</table>
<p>
<em>File header updates are protected with transactions.</em><p>
<h2>Delete File.</h2>
<p>
<h3>Header</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>CLA </td><td>INS </td><td>P1 </td><td>P2 </td><td>P3  </td></tr>
<tr>
<td>80 </td><td>E4 </td><td>00 </td><td>00 </td><td>02  </td></tr>
</table>
<p>
<h3>Command data</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>Byte(s) </td><td>Description </td><td>Length  </td></tr>
<tr>
<td>1 - 2 </td><td>FID </td><td>2  </td></tr>
</table>
<p>
<h3>Status words</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>SW </td><td>Description  </td></tr>
<tr>
<td>90 00 </td><td>Command completed successfully  </td></tr>
<tr>
<td>67 00 </td><td>Wrong Lc  </td></tr>
<tr>
<td>69 82 </td><td>Security status not satisfied  </td></tr>
<tr>
<td>69 86 </td><td>Command not allowed (no DF selected)  </td></tr>
<tr>
<td>6A 82 </td><td>File not found  </td></tr>
<tr>
<td>6A 86 </td><td>Incorrect parameters P1-P2  </td></tr>
</table>
<p>
<h3>Description</h3>
<p>
The file with the specified FID is deleted from the current file, which must be a DF or the MF. Also the access conditions for delete must be satisfied and the specified file must be the last one in the DF/MF. Deletion of a DF, which contains EFs, is possible.<p>
<em>File header updates are protected with transactions.</em><p>
<h2>External Authentication.</h2>
<p>
<h3>Header</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>CLA </td><td>INS </td><td>P1 </td><td>P2 </td><td>P3  </td></tr>
<tr>
<td>80 </td><td>82 </td><td>00 </td><td>00 </td><td>08  </td></tr>
</table>
<p>
<h3>Command data</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>Byte(s) </td><td>Description </td><td>Length  </td></tr>
<tr>
<td>1 - 8 </td><td>Encrypted Challenge </td><td>8  </td></tr>
</table>
<p>
<h3>Status words</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>SW </td><td>Description  </td></tr>
<tr>
<td>90 00 </td><td>Command completed successfully  </td></tr>
<tr>
<td>63 CX </td><td>Verification failed, retry counter specified  </td></tr>
<tr>
<td>67 00 </td><td>Wrong Lc  </td></tr>
<tr>
<td>69 83 </td><td>Authentication method blocked  </td></tr>
<tr>
<td>69 85 </td><td>Conditions of use not satisfied  </td></tr>
<tr>
<td>6A 86 </td><td>Incorrect parameters P1-P2  </td></tr>
<tr>
<td>6A 88 </td><td>Referenced data not found  </td></tr>
</table>
<p>
<h3>Description</h3>
<p>
Directly before this command a 8 byte challenge must be fetched from the card with the Get Challenge command. This challenge must then be encrypted with the TEA algorithm and the External Authentication key. For authentication the resulting data must then be sent back via this command.<p>
<em>Warning: Currently the retry counter is not handled in a secure way. For more information see e.g. Rankl/Effing.</em><p>
<h2>Get Challenge</h2>
<p>
<h3>Header</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>CLA </td><td>INS </td><td>P1 </td><td>P2 </td><td>P3  </td></tr>
<tr>
<td>80 </td><td>84 </td><td>00 </td><td>00 </td><td>08  </td></tr>
</table>
<p>
<h3>Response data</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>Byte(s) </td><td>Description </td><td>Length  </td></tr>
<tr>
<td>1 - 8 </td><td>Random Challenge </td><td>8  </td></tr>
</table>
<p>
<h3>Status words</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>SW </td><td>Description  </td></tr>
<tr>
<td>90 00 </td><td>Command completed successfully  </td></tr>
<tr>
<td>67 00 </td><td>Wrong Le  </td></tr>
<tr>
<td>6A 86 </td><td>Incorrect parameters P1-P2  </td></tr>
</table>
<p>
<h3>Description</h3>
<p>
Returns a challenge usable for the External Authentication command, which must then be the next issued command.<p>
<em>Warning: On the current hardware this challenge is produced with a PRNG based on TEA. It is not evaluated, if the current mechanism is appropriate for this task.</em><p>
<h2>Get Response.</h2>
<p>
<h3>Header</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>CLA </td><td>INS </td><td>P1 </td><td>P2 </td><td>P3  </td></tr>
<tr>
<td>80 </td><td>C0 </td><td>00 </td><td>00 </td><td>Length  </td></tr>
</table>
<p>
<h3>Response data after Internal Authenticate</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>Byte(s) </td><td>Description </td><td>Length  </td></tr>
<tr>
<td>1 - 8 </td><td>Internal Authentication key encrypted challenge </td><td>8  </td></tr>
</table>
<p>
<h3>Response data after Select</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>Byte(s) </td><td>Description </td><td>Length  </td></tr>
<tr>
<td>1 - 2 </td><td>Size </td><td>2  </td></tr>
<tr>
<td>3 - 4 </td><td>FID </td><td>2  </td></tr>
<tr>
<td>5 </td><td>File type (DF: 38, EF: 00) </td><td>1  </td></tr>
<tr>
<td>6 </td><td>Access conditions </td><td>1  </td></tr>
</table>
<p>
<h3>Status words</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>SW </td><td>Description  </td></tr>
<tr>
<td>90 00 </td><td>Command completed successfully  </td></tr>
<tr>
<td>69 85 </td><td>Wrong condition (No data available)  </td></tr>
<tr>
<td>6A 86 </td><td>Incorrect parameters P1-P2  </td></tr>
<tr>
<td>6C XX </td><td>Wrong Le  </td></tr>
</table>
<p>
<h3>Description</h3>
<p>
This command fetches data from Internal Authentication and Select. These commands signal the availability of data with the status word 61XX. For more details about the data returned after a Select, see at the Create command.<p>
<h2>Internal Authentication.</h2>
<p>
<h3>Header</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>CLA </td><td>INS </td><td>P1 </td><td>P2 </td><td>P3  </td></tr>
<tr>
<td>80 </td><td>88 </td><td>00 </td><td>Decrypt </td><td>08  </td></tr>
</table>
<p>
This command decrypts the data if P2 is 01. This functionality is only enabled when CONF_WITH_DECRYPT is set to 1.<p>
<h3>Command data</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>Byte(s) </td><td>Description </td><td>Length  </td></tr>
<tr>
<td>1 - 8 </td><td>Random Challenge </td><td>8  </td></tr>
</table>
<p>
<h3>Status words</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>SW </td><td>Description  </td></tr>
<tr>
<td>61 08 </td><td>Command completed successfully (Data available)  </td></tr>
<tr>
<td>67 00 </td><td>Wrong Lc  </td></tr>
<tr>
<td>69 85 </td><td>Conditions of use not satisfied  </td></tr>
<tr>
<td>6A 86 </td><td>Incorrect parameters P1-P2  </td></tr>
<tr>
<td>6A 88 </td><td>Referenced data not found  </td></tr>
</table>
<p>
<h3>Description</h3>
<p>
Provieds a random challenge to the card. It encryptes the challenge with TEA and the Internal Authentication key and makes it available via Get Response. For the successful execution either the PIN or the External Authentication key must have been successfully verified previously.<p>
Because of possibility to decrypt data, this command can easily be used to implement some form of Remotely Keyed Encryption.<p>
<h2>Read Binary.</h2>
<p>
<h3>Header</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>CLA </td><td>INS </td><td>P1 </td><td>P2 </td><td>P3  </td></tr>
<tr>
<td>80 </td><td>B0 </td><td>Offset high </td><td>Offest low </td><td>Length  </td></tr>
</table>
<p>
<h3>Response data</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>Byte(s) </td><td>Description </td><td>Length  </td></tr>
<tr>
<td>1 - Length </td><td>Data </td><td>Length  </td></tr>
</table>
<p>
<h3>Status words</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>SW </td><td>Description  </td></tr>
<tr>
<td>90 00 </td><td>Command completed successfully  </td></tr>
<tr>
<td>69 82 </td><td>Security status not satisfied  </td></tr>
<tr>
<td>69 86 </td><td>Command not allowed (no EF selected)  </td></tr>
<tr>
<td>6A 82 </td><td>File not found  </td></tr>
<tr>
<td>6A 84 </td><td>File to short  </td></tr>
<tr>
<td>6B 00 </td><td>Wrong parameters (offset outside EF)  </td></tr>
</table>
<p>
<h3>Description</h3>
<p>
Reads <em>Lenght</em> bytes from <em>Offset</em> of the currently selected EF.<p>
<h2>Select File.</h2>
<p>
<h3>Header</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>CLA </td><td>INS </td><td>P1 </td><td>P2 </td><td>P3  </td></tr>
<tr>
<td>80 </td><td>A4 </td><td>00 </td><td>00 </td><td>02  </td></tr>
</table>
<p>
<h3>Command data</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>Byte(s) </td><td>Description </td><td>Length  </td></tr>
<tr>
<td>1 - 2 </td><td>FID </td><td>2  </td></tr>
</table>
<p>
<h3>Status words</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>SW </td><td>Description  </td></tr>
<tr>
<td>61 06 </td><td>Command completed successfully  </td></tr>
<tr>
<td>67 00 </td><td>Wrong Lc  </td></tr>
<tr>
<td>6A 82 </td><td>File not found  </td></tr>
<tr>
<td>6A 86 </td><td>Incorrect parameters P1-P2  </td></tr>
</table>
<p>
<h3>Description</h3>
<p>
It tries to select a file with the specified FID and searches for it in the following order:<p>
<ol>
<li>
EF in the current MF/DF </li>
<li>
DF in MF </li>
</ol>
<p>
If FID is 3F00, the MF is always selected.<p>
<h2>Unblock PIN.</h2>
<p>
<h3>Header</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>CLA </td><td>INS </td><td>P1 </td><td>P2 </td><td>P3  </td></tr>
<tr>
<td>80 </td><td>2C </td><td>00 </td><td>00 </td><td>10  </td></tr>
</table>
<p>
<h3>Command data</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>Byte(s) </td><td>Description </td><td>Length  </td></tr>
<tr>
<td>1 - 8 </td><td>PUK </td><td>8  </td></tr>
<tr>
<td>9 - 16 </td><td>New PIN </td><td>8  </td></tr>
</table>
<p>
<h3>Status words</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>SW </td><td>Description  </td></tr>
<tr>
<td>90 00 </td><td>Command completed successfully  </td></tr>
<tr>
<td>63 CX </td><td>Verification failed, retry counter specified  </td></tr>
<tr>
<td>67 00 </td><td>Wrong Lc  </td></tr>
<tr>
<td>69 83 </td><td>Authentication method blocked  </td></tr>
<tr>
<td>6A 86 </td><td>Incorrect parameters P1-P2  </td></tr>
<tr>
<td>6A 88 </td><td>Referenced data not found  </td></tr>
</table>
<p>
<h3>Description</h3>
<p>
This command changes the PIN of the card and resets the retry counter of this PIN. The first eight bytes of the data is the PUK, which is checked for correctness. The second four bytes of the data is the new PIN, which will be written. On success the AUTH_FLAG_PIN bit in authstate is set, on fauilure it is cleared.<p>
<em>Warning: Currently the retry counter is not handled in a secure way. For more information see e.g. Rankl/Effing.</em><p>
<em>PIN update is protected with transactions.</em><p>
<h2>Update Binary.</h2>
<p>
<h3>Header</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>CLA </td><td>INS </td><td>P1 </td><td>P2 </td><td>P3  </td></tr>
<tr>
<td>80 </td><td>D6 </td><td>Offset high </td><td>Offset low </td><td>Length  </td></tr>
</table>
<p>
<h3>Command data</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>Byte(s) </td><td>Description </td><td>Length  </td></tr>
<tr>
<td>1 - Length </td><td>Data </td><td>Length  </td></tr>
</table>
<p>
<h3>Status words</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>SW </td><td>Description  </td></tr>
<tr>
<td>90 00 </td><td>Command completed successfully  </td></tr>
<tr>
<td>65 00 </td><td>Memory failure (unsuccessful writing)  </td></tr>
<tr>
<td>67 00 </td><td>Wrong Le  </td></tr>
<tr>
<td>69 82 </td><td>Security status not satisfied  </td></tr>
<tr>
<td>69 86 </td><td>Command not allowed (no EF selected)  </td></tr>
<tr>
<td>6A 82 </td><td>File not found  </td></tr>
<tr>
<td>6A 84 </td><td>File to short  </td></tr>
<tr>
<td>6B 00 </td><td>Wrong parameters (offset outside EF)  </td></tr>
</table>
<p>
<h3>Description</h3>
<p>
Writes <em>Lenght</em> bytes to <em>Offset</em> of the currently selected EF.<p>
<em>Data updates are NOT protected with transactions.</em><p>
<h2>Verify Key</h2>
<p>
<h3>Header</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>CLA </td><td>INS </td><td>P1 </td><td>P2 </td><td>P3  </td></tr>
<tr>
<td>80 </td><td>2A </td><td>00 </td><td>00 </td><td>10  </td></tr>
</table>
<p>
<h3>Command data</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>Byte(s) </td><td>Description </td><td>Length  </td></tr>
<tr>
<td>1 - 16 </td><td>External Authentication Key </td><td>16  </td></tr>
</table>
<p>
<h3>Status words</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>SW </td><td>Description  </td></tr>
<tr>
<td>90 00 </td><td>Command completed successfully  </td></tr>
<tr>
<td>63 CX </td><td>Verification failed, retry counter specified  </td></tr>
<tr>
<td>67 00 </td><td>Wrong Lc  </td></tr>
<tr>
<td>69 83 </td><td>Authentication method blocked  </td></tr>
<tr>
<td>6A 86 </td><td>Incorrect parameters P1-P2  </td></tr>
<tr>
<td>6A 88 </td><td>Referenced data not found  </td></tr>
</table>
<p>
<h3>Description</h3>
<p>
Verifies the External Authentication key as 16 byte plain text in the data part of the command. On success the AUTH_FLAG_KEY bit in authstate is set, on failure it is cleared.<p>
<em>Warning: Currently the retry counter is not handled in a secure way. For more information see e.g. Rankl/Effing.</em><p>
<h2>Verify PIN</h2>
<p>
<h3>Header</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>CLA </td><td>INS </td><td>P1 </td><td>P2 </td><td>P3  </td></tr>
<tr>
<td>80 </td><td>20 </td><td>00 </td><td>00 </td><td>08  </td></tr>
</table>
<p>
<h3>Command data</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>Byte(s) </td><td>Description </td><td>Length  </td></tr>
<tr>
<td>1 - 8 </td><td>PIN </td><td>8  </td></tr>
</table>
<p>
<h3>Status words</h3>
<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td>SW </td><td>Description  </td></tr>
<tr>
<td>90 00 </td><td>Command completed successfully  </td></tr>
<tr>
<td>63 CX </td><td>Verification failed, retry counter specified  </td></tr>
<tr>
<td>67 00 </td><td>Wrong Lc  </td></tr>
<tr>
<td>69 83 </td><td>Authentication method blocked  </td></tr>
<tr>
<td>6A 86 </td><td>Incorrect parameters P1-P2  </td></tr>
<tr>
<td>6A 88 </td><td>Referenced data not found  </td></tr>
</table>
<p>
<h3>Description</h3>
<p>
This command verifies the PIN. The four data bytes contain the user supplied PIN, which is checked for correctness. On success the AUTH_FLAG_PIN bit in authstate is set, on fauilure it is cleared.<p>
<em>Warning: Currently the retry counter is not handled in a secure way. For more information see e.g. Rankl/Effing.</em><p>
<h1>Developers</h1>
<p>
<ul>
<li>
Matthias Bruestle &lt;<a href="mailto:m@mbsks.franken.de">m@mbsks.franken.de</a>&gt; </li>
</ul>
<p>
<h1>License</h1>
<p>
This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.<p>
This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.<p>
You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA <hr><address><small>
Copyright 2002 by Matthias Bruestle. This is licensed under the GNU
General Public License.
</small></address>
</body>
</html>
